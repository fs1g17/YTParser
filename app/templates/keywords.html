{% extends "base.html" %}

{% block title %}YTParser{% endblock %}

{% block head %}
{{ super() }}
{% endblock %}

{% block page_content %}

<div class="container-fluid">
    <div class="row">
        <div class="col-auto">
            <h1>Keyword Search</h1>
        </div>
        <div class="col-auto">
            <div class="spinner-border" role="status" id='spinner'>
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </div>
</div>

<p id="messages"></p>

<ul id="keywords">
</ul>

<!-- <div class="container-fluid"> -->
<div class="container"> 
    <div class="row">
        <div class="col-8">
            <input class="form-control" id="keyword_input" placeholder="Enter a keyword">
        </div>
        <div class="col-1">
            <button type="button" class="btn btn-primary" id="add_keyword" onclick="sendKeyword(event)">OK</button>
        </div>
        <div class="col-2">
            <button type="button" class="btn btn-primary" id="search" onclick="sendSearch(event)">Search</button>
        </div>
    </div>
</div>

<!-- <div class="container-fluid"> -->
<div class="container">    
    <table class="table">
        <thead>
            <tr>
                <th scope="col" style="width: 10%">Sponsor</th>
                <th scope="col" style="width: 10%">Channel</th>
                <th scope="col" style="width: 10%">Date</th>
                <th scope="col" style="width: 10%">Views</th>
                <th scope="col" style="width: 60%">Link</th>
            </tr>
        </thead>
        <tbody id="tablecontents" class="tableRowWidth">
        </tbody>
    </table>

    <form>
        <div class="form-group row">
            <div class="col-6">
                <!-- <button type="button" class="btn btn-primary" id="prev" onclick="">back</button> -->
                <button type="button" class="btn btn-primary" id="prev" onclick="sendPrev(event)">back</button>
            </div>
            <div class="col-6">
                <!-- <button type="button" class="btn btn-primary float-right" id="next" onclick="">next</button> -->
                <button type="button" class="btn btn-primary float-right" id="next" onclick="sendNext(event)">next</button>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script charset="utf-8">

    function connect() {
        return new Promise(function(resolve,reject) {
            var ws = new WebSocket("ws://localhost:80/keywords/ws");
            ws.onopen = function() {
                resolve(ws);
            };
            ws.onerror = function(err){
                reject(err);
            };
        });
    }

    async function procesing() {
        try{
            let ws = await connect();
            console.log("connected!");

            //await ws.send(JSON.stringify({"status":"ready"}));
            await ws.send({"status":"ready"});
            console.log("notified server");

            var table_body = document.getElementById("tablecontents");
            var spinner = document.getElementById("spinner") 
            var keyword_input = document.getElementById("keyword_input")

            ws.onclose = function() {
                console.log("WEBSOCKET CLOSED");
            }

            ws.onerror = function(err) {
                console.log("ERROR: " + err);
            }
            
            ws.onmessage = function(event) {
                try {
                    info = JSON.parse(event.data);
                    if(info.hasOwnProperty('message')){
                        console.log("received: " + JSON.stringify(info));
                        return;
                    }

                    spinner.style.visibility = "hidden";
                    console.log("Parsed as JSON");
                    keys = Object.keys(info);
                    console.log("Got the keys");

                    var new_row = table_body.insertRow();

                    for(i=0; i<keys.length; i++){
                        var cell = new_row.insertCell();
                        var cell_val = document.createTextNode(info[keys[i]]);
                        cell.appendChild(cell_val);
                    }

                    console.log("Looped through all the values!");

                    new_row = table_body.insertRow();
                } catch(err) {
                    //notify the user of outcome of action
                    error_message = "ERROR: " + err;
                    document.getElementById("messages").value = error_message;
                    console.log("ERROR" + err);
                } 
            }

            document.getElementById('prev').onclick = await function() {
                ws.send({"action":"prev"});
            }

            document.getElementById('next').onclick = await function() {
                ws.send({"action":"next"});
            }

            document.getElementById('search').onclick = await function() {
                spinner.style.visibility = "visible";
                console.log("querying the database");
                ws.send({"action":"search"});
                console.log("finished sending")
            }

            document.getElementById('add_keyword').onclick = await function(){
                keyword = keyword_input.value;

                if(keyword.length > 0){
                    try{
                        console.log("adding keyword")
                        //message = JSON.stringify({"keyword":keyword});
                        ws.send({"keyword":keyword});
                        console.log("sent keyword to server")
                        notification = "Added keyword: " + keyword; 
                        keyword_input.value = '';
                    } catch(err){
                        notification = "Failed to add keyword: " + err.message;
                        console.log("ERROR: when adding keyword got " + err.message)
                    }
                } else {
                    notification = "Keyword can't be empty!";
                }

                // Add keyword to keywords (so user can see what keywords have been added)
                var node = document.createElement("li");
                var textNode = document.createTextNode(keyword);
                node.appendChild(textNode);
                document.getElementById("keywords").appendChild(node);

                //notify the user of outcome of action
                document.getElementById("messages").value = notification;
            }

        } catch(error){
            console.log("ERROR: " + error);
        }
    }

    //procesing();

    var ws = new WebSocket("ws://localhost:80/keywords/ws");
    var table_body = document.getElementById("tablecontents");
    var spinner = document.getElementById("spinner"); 
    spinner.style.visibility = "hidden";
    var keyword_input = document.getElementById("keyword_input")

    ws.onopen = function(event) {
        console.log("connection to server established");
    }

    ws.onclose = function() {
        console.log("websocket is closing");
    }

    ws.onmessage = function(event) {
        try{
            info = JSON.parse(event.data);
            if(info.hasOwnProperty('message')){
                console.log("received: ", event.data);
            } else if(info.hasOwnProperty('action')){
                if(info['action'] == 'clear'){
                    table_body.innerHTML = "";
                }
            } else {
                //process data here
                console.log("received: " + JSON.stringify(info))
                spinner.style.visibility = "hidden";
                console.log("Parsed as JSON");
                keys = Object.keys(info);
                console.log("Got the keys");

                var new_row = table_body.insertRow();

                for(i=0; i<keys.length; i++){
                    var cell = new_row.insertCell();
                    var cell_val = document.createTextNode(info[keys[i]]);
                    cell.appendChild(cell_val);
                }

                console.log("Looped through all the values!");
            }
        } catch(err){
            console.log("caught error ", err);
        }
    }

    function sendNext(event) {
        ws.send(JSON.stringify({"action":"next"}))
        event.preventDefault();
    }

    function sendPrev(event) {
        ws.send(JSON.stringify({"action":"prev"}))
        event.preventDefault();
    }

    function sendKeyword(event) {
        new_keyword = document.getElementById('keyword_input').value;
        if(new_keyword.length > 0){
            ws.send(JSON.stringify({"action":"add_keyword","keyword":new_keyword}))
            document.getElementById('keyword_input').value = '';
            console.log("sent keyword: " + new_keyword);
            document.getElementById('search').style.visibility = "visible";
        } else {
            console.log('didnt send anything, as keyword is empty!');
        }
        event.preventDefault();
    }

    function sendSearch(event) {
        spinner.style.visibility = "visible";
        document.getElementById('search').style.visibility = "hidden";
        ws.send(JSON.stringify({"action":"search"}))
        event.preventDefault();
    }

    //---------------- WORKING
    // var ws = new WebSocket("ws://localhost:80/keywords/ws");
    
    // ws.onopen = function(event) {
    //     console.log("connection to server established");
    // }

    // ws.onclose = function() {
    //     console.log("websocket is closing");
    // }

    // ws.onmessage = function(event) {
    //     console.log("received: ", event.data);
    // }

    // function sendNext(event) {
    //     ws.send("next")
    //     event.preventDefault();
    // }

    // function sendPrev(event) {
    //     ws.send("prev")
    //     event.preventDefault();
    // }

    // function sendSearch(event) {
    //     ws.send("search")
    //     event.preventDefault();
    // }

</script>

{% endblock %}